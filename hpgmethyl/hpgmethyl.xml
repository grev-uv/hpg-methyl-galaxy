<tool id="hpgmethyl" name="HPG-Methyl" version="3.1.3-2">
  <description>Detect 5mC per-base levels in each sequence</description>
  <command><![CDATA[
    $__tool_directory__/hpg-methyl bs 
    #if str( $input_gen.input_gen_selector ) == "g37":
    ## GALAXY ADMINISTRATOR: Replace with the G37 BWT index installation directory
      -i /genome/ssd/index_bs_previous
    #else if str( $input_gen.input_gen_selector ) == "g38":
    ## GALAXY ADMINISTRATOR: Replace with the G38 BWT index installation directory
      -i /path/to/the/g38/index
    #else if str( $input_gen.input_gen_selector ) == "ncbi":
    ## GALAXY ADMINISTRATOR: Replace with the NCBI BWT index installation directory
      -i /path/to/the/ncbi/index
    #else
      -i $__tool_directory__/bwt_indices/$__user_id__/$input_gen.fa.name 
    #end if
    -f $input_seq --cpu-threads $cpu --write-mcontext
    #if str( $report_mode.report_selector ) == "best":
      --report-best 
    #else if str( $report_mode.report_selector ) == "n_best":
      --report-n-best $report_mode.n
    #else if str( $report_mode.report_selector ) == "n_first":
      --report-n-first $report_mode.n
    #end if
    -o $alignments.files_path; mv $alignments.files_path/alignments.bam alignments.bam; mv $alignments.files_path/*.txt .; samtools view alignments.bam > alignments.sam; rm alignments.bam
  ]]></command>
  <inputs>
    <param format="fastq" name="input_seq" type="data" label="Input FASTQ sequence" />
    <conditional name="input_gen">
      <param name="input_gen_selector" type="select" label="Reference genome">
        <!-- GALAXY ADMINISTRATOR:
             BWT indices for reference genomes are optimized for speed and can take
             large ammounts of disk space, up to 250 GB per index. Depending on the
             target workflow of the HPG-Methyl installation, you can enable or disable
             the creation of user BWT indices from FASTA files, and enable or disable
             any of the built-in reference genomes.

             When enabling the built-in reference genomes, the <command> section must
             be edited in the specified areas to point to the directory where a given
             built-in index is located in the filesystem.
        -->
        <option value="g37" selected="True">Homo Sapiens GRCh37.68 (built-in)</option>
        <option value="g38">Homo Sapiens GRCh38.p10 (built-in)</option>
        <option value="ncbi">Homo Sapiens NCBI36 (built-in)</option>
        <option value="custom">Custom FASTA (the corresponding BWT index must exist)</option>
      </param>
      <when value="custom">
         <param format="fasta" name="fa" type="data" label="Reference genome FASTA" />
      </when>
    </conditional>
    <conditional name="report_mode">
      <param name="report_selector" type="select" label="Alignment reporting mode">
        <option value="all" selected="True">Report all (default)</option>
        <option value="best">Report best</option>
        <option value="n_best">Report n-best</option>
        <option value="n_first">Report n-first</option>
      </param>
      <when value="n_best">
        <param name="n" value="20" type="integer" label="Number of alignments to report" />
      </when>
      <when value="n_first">
        <param name="n" value="20" type="integer" label="Number of alignments to report" />
      </when>
    </conditional>
    <param name="cpu" type="integer" value="4" label="CPU threads to use"/>
  </inputs>
  <outputs>
    <data format="sam"     name="alignments"  from_work_dir="alignments.sam"  label="SAM alignments on $input_seq.name" />
    <data format="tabular" name="CpG_context" from_work_dir="CpG_context.txt" label="CpG context on $input_seq.name" />
    <data format="tabular" name="CHG_context" from_work_dir="CHG_context.txt" label="CHG context on $input_seq.name" />
    <data format="tabular" name="CHH_context" from_work_dir="CHH_context.txt" label="CHH context on $input_seq.name" />
    <data format="tabular" name="MUT_context" from_work_dir="MUT_context.txt" label="MUT context on $input_seq.name" />
    <data format="txt"     name="Statistics"  from_work_dir="Statistics.txt"  label="Mapping statistics on $input_seq.name" />
  </outputs>

  <help><![CDATA[
**Introduction**

  | HPG-Methyl is an ultrafast and highly sensitive Next-Generation Sequencing (NGS) 
  | read mapper and methylation context extractor. Compared with other current mapping 
  | and methylation extraction tools, HPG-Methyl offers better sensitivity and shorter 
  | execution times even for long reads.
  |  
  | Since the files generated by HPG-Methyl are fully compatible with the files generated 
  | by other popular tools, it can be used as a drop-in replacement to accelerate existing 
  | methylation analysis pipelines.
  |  
  | Check https://github.com/grev-uv/hpg-methyl for further information and support.

----

**Input sequences**

  | Input sequences must be in FASTQ format. HPG-Methyl can handle several types of sequence
  | files as long as the FASTQ standard is followed. Use the FASTQ Groomer conversion tools
  | to apply conversions if needed.
  |  

  .. class:: warningmark

  | Paired-ended sequences are not supported. Use only single-ended sequences.

**Reference genome**

  | A reference genome is needed to perform the read alignment and extract the methylation information.
  | If your local Galaxy administrator has installed any built-in reference genomes, select the corresponding
  | genome from the list.
  | 
  | If there isn't any built-in genomes, you can select a FASTA file from your current history to use as the
  | reference genome.
  | 

  .. class:: warningmark

  | Before using a custom reference genome, you must create the genome index using the *HPG-Methyl Index* tool.
  | If this tool isn't available in your toolbox, contact your Galaxy administrator.

**Output data**

  | The output data constists of the input sequences aligned to the reference genome in SAM format, with the
  | corresponding methylation context and statistics for each read. Along the alignments, five tabulated datasets
  | are generated with the list of all the genomic bases in the FASTQ files which are in a CpG, CHH, CHG or MUT
  | methylation context. Also, a text file with mapping statistics is generated, listing the percentage of
  | mapped and unmapped reads, the number of bases in a methylation context, along other useful information.

**SAM file optional tags**

  | The *optional* field in the SAM alignment file contains the methylation information for each sequence. The
  | output format follows the same specification as the Bismark methylation caller, meaning that any tool expecting
  | this information will work seamlessly with HPG-Methyl.

**Processing with multiple CPUs**

  | HPG-Methyl can take advantage of all the CPUs in the compute nodes of the Galaxy cluster, speeding up the process
  | drastically as more CPUs are used. Contact your Galaxy administrator to know if multiple CPUs can be used and up
  | to how many CPUs simultaneously.
  ]]></help>

  <stdio>
    <exit_code range="-1"   level="fatal"   description="Generic Error" />
    <exit_code range="1"    level="fatal"   description="BWT index not found" />
  </stdio>

  <citations>
    <citation type="doi">10.1186/s12859-017-1574-3</citation>
  </citations>

</tool>
